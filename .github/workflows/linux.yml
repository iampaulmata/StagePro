name: Linux AppImage

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: System deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libfuse2 fuse patchelf qmake6 qt6-base-dev-tools \
            libxcb-cursor0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-render-util0 \
            libxcb-randr0 libxcb-shape0 libxcb-xinerama0 libxcb-xkb1 \
            libxkbcommon-x11-0 libxkbcommon0 \
            libgl1 libegl1 \
            libdbus-1-3

      - name: Get AppImage tools
        run: |
          chmod +x packaging/get_appimage_tools.sh
          ./packaging/get_appimage_tools.sh

      - name: Build AppImage
        env:
          VERSION: ${{ github.ref_name }}
        run: |
          chmod +x packaging/build_pyinstaller.sh packaging/build_appimage.sh
          cd "$GITHUB_WORKSPACE"
          echo "PWD before pyinstaller: $(pwd)"
          ./packaging/build_appimage.sh

      - uses: actions/upload-artifact@v4
        with:
          name: StagePro-linux
          path: |
            StagePro-*.AppImage
            StagePro-*.AppImage.sha256

      - name: Upload to Release (tags only)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            StagePro-*.AppImage
            StagePro-*.AppImage.sha256

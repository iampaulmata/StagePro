name: CI (Linux/macOS/Windows builds)

on:
  pull_request:
    branches: [ "main" ]
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    name: Build (${{ matrix.platform }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux
            os: ubuntu-latest
          - platform: macos
            os: macos-latest
          - platform: windows
            os: windows-latest

    steps:
      - uses: actions/checkout@v4

      # ---------- Linux ----------
      - name: System deps (Linux)
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libfuse2 fuse patchelf qmake6 qt6-base-dev-tools \
            libxcb-cursor0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-render-util0 \
            libxcb-randr0 libxcb-shape0 libxcb-xinerama0 libxcb-xkb1 \
            libxkbcommon-x11-0 libxkbcommon0 \
            libgl1 libegl1 \
            libdbus-1-3

      - name: Get AppImage tools (Linux)
        if: matrix.platform == 'linux'
        run: |
          chmod +x packaging/get_appimage_tools.sh
          ./packaging/get_appimage_tools.sh

      - name: Build AppImage (Linux)
        if: matrix.platform == 'linux'
        env:
          # CI build label (avoid pretending it's a real version tag)
          VERSION: dev-${{ github.sha }}
        run: |
          chmod +x packaging/build_pyinstaller.sh packaging/build_appimage.sh
          cd "$GITHUB_WORKSPACE"
          ./packaging/build_appimage.sh

      - uses: actions/upload-artifact@v4
        if: matrix.platform == 'linux'
        with:
          name: StagePro-ci-linux
          path: |
            StagePro-*.AppImage
            StagePro-*.AppImage.sha256

      # ---------- macOS ----------
      - uses: actions/setup-python@v5
        if: matrix.platform == 'macos'
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install deps (macOS)
        if: matrix.platform == 'macos'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-build.txt

      - name: Build (PyInstaller) (macOS)
        if: matrix.platform == 'macos'
        run: |
          cd "$GITHUB_WORKSPACE"
          rm -rf build dist
          pyinstaller packaging/stagepro.macos.spec --clean

      - name: Zip .app (macOS)
        if: matrix.platform == 'macos'
        run: |
          REF="dev-${GITHUB_SHA}"
          ditto -c -k --sequesterRsrc --keepParent "dist/StagePro.app" "StagePro-${REF}-macos.zip"

      - uses: actions/upload-artifact@v4
        if: matrix.platform == 'macos'
        with:
          name: StagePro-ci-macos
          path: StagePro-*-macos.zip

      # ---------- Windows ----------
      - uses: actions/setup-python@v5
        if: matrix.platform == 'windows'
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install deps (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-build.txt
          pip install pillow

      - name: Generate .ico from PNG (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          python -c "from PIL import Image; img=Image.open('assets/stagepro.png').convert('RGBA'); img.save('assets/stagepro.ico', sizes=[(16,16),(32,32),(48,48),(64,64),(128,128),(256,256)])"

      - name: Build (PyInstaller) (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          Remove-Item -Recurse -Force build, dist -ErrorAction SilentlyContinue
          pyinstaller stagepro.windows.spec --clean

      - name: Package portable zip (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          $ver = "dev-${{ github.sha }}"
          Compress-Archive -Path "dist\StagePro\*" -DestinationPath "StagePro-$ver-windows-x64-portable.zip" -Force

      - uses: actions/upload-artifact@v4
        if: matrix.platform == 'windows'
        with:
          name: StagePro-ci-windows
          path: StagePro-*-windows-x64-portable.zip

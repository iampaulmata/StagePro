name: Release (tag builds)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref to build (tag like v1.1.0, branch, or commit SHA). Leave blank to use default branch."
        required: false
        default: ""
      version:
        description: "Version string for artifact naming. Defaults to ref (if provided), else tag name (on tag push), else short SHA."
        required: false
        default: ""

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.platform }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux
            os: ubuntu-latest
          - platform: macos
            os: [self-hosted, macOS, X64, stagepro-builder, monterey]
          - platform: windows
            os: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # If manually triggered, allow building a specific ref (tag/branch/sha)
          ref: ${{ inputs.ref }}

      - name: Resolve version
        id: ver
        shell: bash
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            echo "version=${{ inputs.version }}" >> "$GITHUB_OUTPUT"
          elif [ -n "${{ inputs.ref }}" ]; then
            echo "version=${{ inputs.ref }}" >> "$GITHUB_OUTPUT"
          elif [ -n "${GITHUB_REF_NAME}" ]; then
            echo "version=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          else
            echo "version=${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"
          fi
          echo "Resolved version: ${{ steps.ver.outputs.version }}"

      # ---------- Linux ----------
      - name: System deps (Linux)
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libfuse2 fuse patchelf qmake6 qt6-base-dev-tools \
            libxcb-cursor0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-render-util0 \
            libxcb-randr0 libxcb-shape0 libxcb-xinerama0 libxcb-xkb1 \
            libxkbcommon-x11-0 libxkbcommon0 \
            libgl1 libegl1 \
            libdbus-1-3

      - name: Get AppImage tools (Linux)
        if: matrix.platform == 'linux'
        run: |
          chmod +x packaging/get_appimage_tools.sh
          ./packaging/get_appimage_tools.sh

      - name: Build AppImage (Linux)
        if: matrix.platform == 'linux'
        env:
          VERSION: ${{ steps.ver.outputs.version }}
        run: |
          chmod +x packaging/build_pyinstaller.sh packaging/build_appimage.sh
          cd "$GITHUB_WORKSPACE"
          ./packaging/build_appimage.sh

      - uses: actions/upload-artifact@v4
        if: matrix.platform == 'linux'
        with:
          name: release-linux
          path: |
            StagePro-*.AppImage
            StagePro-*.AppImage.sha256

      # ---------- macOS ----------
      - name: Use system Python (macOS self-hosted)
        if: matrix.platform == 'macos'
        shell: bash
        run: |
          python3 --version
          python3 -m pip --version

      - name: Install deps (macOS)
        if: matrix.platform == 'macos'
        shell: bash
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install -r requirements.txt
          python3 -m pip install -r requirements-build.txt

      - name: Build (PyInstaller) (macOS)
        if: matrix.platform == 'macos'
        shell: bash
        run: |
          cd "$GITHUB_WORKSPACE"
          rm -rf build dist
          python3 -m PyInstaller packaging/stagepro.macos.spec --clean

      - name: Zip .app (macOS)
        if: matrix.platform == 'macos'
        shell: bash
        run: |
          REF="${{ steps.ver.outputs.version }}"
          ditto -c -k --sequesterRsrc --keepParent "dist/StagePro.app" "StagePro-${REF}-macos.zip"

      - uses: actions/upload-artifact@v4
        if: matrix.platform == 'macos'
        with:
          name: release-macos
          path: StagePro-*-macos.zip

      # ---------- Windows ----------
      - uses: actions/setup-python@v5
        if: matrix.platform == 'windows'
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install deps (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-build.txt
          pip install pillow

      - name: Generate .ico from PNG (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          python -c "from PIL import Image; img=Image.open('assets/stagepro.png').convert('RGBA'); img.save('assets/stagepro.ico', sizes=[(16,16),(32,32),(48,48),(64,64),(128,128),(256,256)])"

      - name: Build (PyInstaller) (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          Remove-Item -Recurse -Force build, dist -ErrorAction SilentlyContinue
          pyinstaller packaging\stagepro.windows.spec --clean

      - name: Package portable zip (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          $ver = "${{ steps.ver.outputs.version }}"
          Compress-Archive -Path "dist\StagePro\*" -DestinationPath "StagePro-$ver-windows-x64-portable.zip" -Force

      - uses: actions/upload-artifact@v4
        if: matrix.platform == 'windows'
        with:
          name: release-windows
          path: StagePro-*-windows-x64-portable.zip

  publish:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs: [ build ]
    # Only publish a GitHub Release when we have (or were given) a tag-like ref.
    # - Tag push: github.ref is refs/tags/v*
    # - Manual: require inputs.ref to start with v (e.g., v1.1.0)
    if: startsWith(github.ref, 'refs/tags/v') || startsWith(inputs.ref, 'v')

    steps:
      - name: Download all release artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./release
          merge-multiple: true

      - name: List artifacts
        run: |
          ls -la ./release
          find ./release -maxdepth 2 -type f -print

      - name: Publish release and attach files
        uses: softprops/action-gh-release@v2
        with:
          # For manual runs, publish under the provided tag.
          # For tag pushes, this is optional, but harmless.
          tag_name: ${{ inputs.ref || github.ref_name }}
          files: |
            release/StagePro-*-macos.zip
            release/StagePro-*.AppImage
            release/StagePro-*.AppImage.sha256
            release/StagePro-*-windows-x64-portable.zip

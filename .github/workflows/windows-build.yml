name: Windows Portable Build

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install deps
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-build.txt
          pip install pillow

      - name: Generate .ico from PNG (for Windows EXE icon)
        shell: pwsh
        run: |
          python -c "from PIL import Image; img=Image.open('assets/stagepro.png').convert('RGBA'); img.save('assets/stagepro.ico', sizes=[(16,16),(32,32),(48,48),(64,64),(128,128),(256,256)])"

      - name: Build (PyInstaller)
        shell: pwsh
        run: |
          Remove-Item -Recurse -Force build, dist -ErrorAction SilentlyContinue
          pyinstaller stagepro.windows.spec --clean

      - name: Package portable zip
        shell: pwsh
        run: |
          $ver = "${{ github.ref_name }}"
          if (-not $ver.StartsWith("v")) { $ver = "dev" }
          Compress-Archive -Path "dist\StagePro\*" -DestinationPath "StagePro-$ver-windows-x64-portable.zip" -Force

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: StagePro-windows-portable
          path: StagePro-*-windows-x64-portable.zip
